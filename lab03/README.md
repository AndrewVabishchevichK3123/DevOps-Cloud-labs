# Лабораторная работа 3
В данной лабораторной необходимо для начала узнать что же такое CI/CD; почему это очень полезно, а также проанализировать плохой CI/CD файл, написать хороший с исправленными ошибками, и описать все это

## CI/CD (непрерывная интеграция и непрерывное развертывание/поставка)
Это набор подходов, направленных на автоматизацию и улучшение процессов разработки, тестирования и развертывания ПО, что позволяет быстро и удобно выпускать код в продакшен

## Начнем с плохого CI/CD файла
```
# Badci.yml
stages:
  - build
  - test
  - deploy

build_job:
  stage: build
  script:
    - echo "Starting build..."
    - docker build -t my-app:latest . # снова на те же грабли, неопределенность версий
    - echo "Build finished."

test_job:
  stage: test
  script:
    - echo "Starting tests..."
    - pytest tests/
    - echo "Tests finished."

deploy_job:
  stage: deploy
  script:
    - echo "Deploying..."
    - scp -r ./app user@production:/var/www/my-app # SCP — некруто
  only:
    - master

```

* Неопределенность версий (использование latest):

Использование тега latest в Docker-образах может привести к разным результатам при каждом запуске пайплайна, так как образ будет меняться, и это может вызвать нестабильность.

* Отсутствие кеширования Docker слоев:

Каждый раз билд Docker начинается с нуля, что увеличивает время выполнения пайплайна и нагрузку на инфраструктуру.

* Прямое использование SCP для деплоя:

SCP — это небезопасный и непродуктивный способ развертывания. Он не поддерживает откаты и не интегрируется с системами управления версиями для деплоя.

* Отсутствие параллельного выполнения задач:

Все задачи выполняются последовательно, что увеличивает общее время выполнения пайплайна.

* Отсутствие проверки веток при деплое:

В данном примере деплой разрешен только для ветки master. Это ограничивает возможности работы с другими окружениями, что затрудняет CI/CD для многоветочной разработки.


Попробуем все исправить

```
# Goodci.yml
stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: my-app
  DOCKER_TAG: $CI_COMMIT_SHA
  CACHE_REGISTRY: registry.gitlab.com/my-app/cache

before_script:
  - echo "Preparing environment..."

build_job:
  stage: build
  script:
    - echo "Starting build with cache..."
    - docker build --cache-from $CACHE_REGISTRY -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
  only:
    - develop
    - master

test_job:
  stage: test
  script:
    - echo "Starting tests..."
    - pytest tests/
  parallel:
    matrix:
      - PYTHON_VERSION: 3.8
      - PYTHON_VERSION: 3.9
  only:
    - develop
    - master

deploy_job:
  stage: deploy
  script:
    - echo "Deploying application..."
    - kubectl set image deployment/my-app my-app=$DOCKER_IMAGE:$DOCKER_TAG --record
  environment:
    name: production
  only:
    - master
```

* Исправление неопределенности версий:

В "хорошем" CI/CD файле вместо тега latest используется переменная $CI_COMMIT_SHA, которая уникальна для каждого коммита, что гарантирует постоянтсво версий и предсказуемость сборок.

* Исправление кеширования Docker слоев:

Включено кеширование Docker слоев с использованием переменной --cache-from, что сокращает время сборки (ура) и снижает нагрузку на ресурсы.

* Исправление деплоя:

Вместо небезопасного SCP используется деплой через Kubernetes с командой kubectl set image, что позволяет легко управлять откатами и историями изменений в продакшене.

* Параллельное выполнение тестов:

Включена параллелизация тестов по различным версиям Python с использованием matrix параметра, что позволяет ускорить процесс CI/CD.

* Разделение окружений:

Добавлено использование разных веток для билдов и деплоя в разные окружения, что позволяет развертывать приложение на различных стадиях разработки.

## Заключение

CI/CD дейстивтельно интересная и полезная методика. Сатира про Васю хоть и пассивно-агрессивная, но актуальна, и, судя по всему, основана на реальной истории...
